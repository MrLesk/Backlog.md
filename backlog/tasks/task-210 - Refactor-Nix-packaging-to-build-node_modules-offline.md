---
id: task-210
title: Refactor Nix packaging to build node_modules offline
status: done
assignee: []
created_date: '2025-07-26'
updated_date: '2025-07-27'
labels:
  - nix
  - build
  - packaging
dependencies: []
---

## Description

Our current flake.nix runs 'bun install' inside the Nix build. Nix builds run without internet access, so trying to download tailwindcss and other dependencies in the build causes a 'connection refused' error. We want to refactor the Nix packaging so that dependencies are fetched in a separate, fixed-output derivation (as demonstrated in the GitHub issue), then copied into the build. This will allow 'nix build' and 'nix run' to succeed offline.

## Acceptance Criteria

- [x] The Nix flake uses a separate derivation to build node_modules and defines outputHash values for each supported platform. The main derivation copies this folder instead of running 'bun install'
- [x] nix build succeeds in a clean sandbox (no network access) and produces a working backlog binary
- [x] nix run . -- --version prints the CLI version without errors on supported platforms
- [x] Documentation in README or a scripts/ helper explains how to update the node_modules hashes when dependencies change

## Implementation Notes

Successfully implemented using nixpkgs' `buildNpmPackage` approach:

1. **Generated package-lock.json** from existing package.json for npm compatibility
2. **Used buildNpmPackage** with `npmDepsHash` for reproducible dependency fetching  
3. **Configured build environment** with `--ignore-scripts` and `HUSKY=0` to avoid issues
4. **Used Bun for compilation** while leveraging npm's lockfile for dependency resolution

The solution provides offline builds while maintaining compatibility with the existing Bun-based development workflow.
